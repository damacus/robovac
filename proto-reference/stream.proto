/**
 * 流通道 [EN: Stream channel]
 */
syntax = "proto3";

// option optimize_for = LITE_RUNTIME;

package proto.cloud.stream;

import "proto/cloud/common.proto";
import "proto/cloud/clean_param.proto";
import "proto/cloud/control.proto";
import "proto/cloud/scene.proto";

/**
 * 通道、版本信息. [EN: Channel and version information.]
 *
 * @note: Delimited 方式序列化. [EN: @note: Serialized in Delimited way.]
 */
message Metadata {
    message Versions {
        // 只针对非 protobuf 格式的通道，protobuf协议本身是向下兼容的； [EN: Only for non-protobuf format channels, protobuf protocol itself is backward compatible;]
        uint32 map_data = 1;
    }
    Versions versions = 1;

    message ChanIds {
        // 地图信息通道，使用 message MapInfo 解析; [EN: Map info channel, parse using message MapInfo;]
        uint32 map_info = 1;

        // 路径数据通道，使用 message Path 解析; [EN: Path data channel, parse using message Path;]
        uint32 path = 2;

        // 房间轮廓，使用 message RoomOutline 解析; [EN: Room outline, parse using message RoomOutline;]
        uint32 room_outline = 3;

        // 房间参数信息，使用 message RoomParams 解析; [EN: Room parameters info, parse using message RoomParams;]
        uint32 room_params = 4;

        // 禁区信息，使用 message RestrictedZone 解析; [EN: Restricted zone info, parse using message RestrictedZone;]
        uint32 restricted_zone = 5;

        // 动态数据，主要是位姿，使用 message DynamicData 解析; [EN: Dynamic data, mainly pose, parse using message DynamicData;]
        uint32 dynamic_data = 6;

        // 临时数据通道，包括选区、指哪到哪等参数，使用 message TemporaryData 解析; [EN: Temporary data channel, including zone selection, point-to-point, etc., parse using message TemporaryData;]
        uint32 temporary_data = 7;

        // 视觉识别的物体信息，使用 message ObstacleInfo 解析; [EN: Visually recognized object info, parse using message ObstacleInfo;]
        uint32 obstacle_info = 8;

        // 地图数据，使用 message Map 解析. [EN: Map data, parse using message Map.]
        uint32 map_data = 9;

        // 巡航点数据，使用 message CruiseData 解析; [EN: Cruise point data, parse using message CruiseData;]
        uint32 cruise_data = 10;
    }
    ChanIds chan_ids = 2;
}

/**
 * 地图信息. [EN: Map information.]
 *
 * @note: Delimited 方式序列化. [EN: @note: Serialized in Delimited way.]
 */
message MapInfo {
    uint32 map_id = 1;  // id 1 不再使用，兼容回放系统留到 2023/01/22 再删除 [EN: id 1 no longer used, kept for playback system compatibility until 2023/01/22 then delete]

    uint32 width = 2;
    uint32 height = 3;
    uint32 resolution = 4;    // 单位： m x 100 [EN: Unit: m x 100]

    Point origin = 5;         // 原点 [EN: Origin]
    repeated Pose docks = 6;  // 支持多个充电座/基站 [EN: Supports multiple charging docks/stations]

    enum Type {
        INCOMPLETE = 0;     // 不完善的地图 [EN: Incomplete map]
        ROUGH = 1;          // 粗糙的完整地图（快速产生的地图） [EN: Rough complete map (quickly generated map)]
        EFFECTIVE = 2;      // 有效的完整地图（清洁建图、快速建图后继续清洁产生的地图） [EN: Effective complete map (map from cleaning mapping, or continued cleaning after fast mapping)]
        LIST_FULL = 3;      // 列表已满（通知 app 需要替换一张多地图或者忽略当前地图） [EN: List full (notify app to replace a multi-map or ignore current map)]
    }
    Type type = 7;

    uint32 seq = 8;  // id 8 不再使用，兼容回放系统留到 2023/01/22 再删除 [EN: id 8 no longer used, kept for playback system compatibility until 2023/01/22 then delete]
    uint32 angle = 9;    // 顺时针的角度的度数，如 90，180 [EN: Clockwise angle in degrees, e.g. 90, 180]

    message Dock {
        enum Type {
            ADAPTER = 0;    // 充电座 [EN: Charging dock]
            STATION = 1;    // 基站 [EN: Station]
        }
        Dock.Type type = 1;
        Pose pose = 2;
    }
    repeated Dock docks_v2 = 10;  // 支持多个充电座/基站 [EN: Supports multiple charging docks/stations]
}

/**
 * 地图帧数据, 可全量和增量上传. [EN: Map frame data, can be full or incremental upload.]
 *     当 Frame 为 I 时，表示全量地图，机器端会先清除地图subid通道数据； [EN:     When Frame is I, it means full map, device will first clear map subid channel data;]
 *     当 Frame 为 P 时，表示增量地图； [EN:     When Frame is P, it means incremental map;]
 *
 * @note: Delimited 方式序列化. [EN: @note: Serialized in Delimited way.]
 */
message Map {
    uint32 map_id = 1;  // id 1 不再使用，兼容回放系统留到 2023/01/22 再删除 [EN: id 1 no longer used, kept for playback system compatibility until 2023/01/22 then delete]
    uint32 seq = 2;  // id 2 不再使用，兼容回放系统留到 2023/01/22 再删除 [EN: id 2 no longer used, kept for playback system compatibility until 2023/01/22 then delete]

    enum Frame {
        I = 0;   // 全量地图 [EN: Full map]
        P = 1;   // 增量地图 [EN: Incremental map]
    }
    Frame frame = 3;

    enum PixelValue {
        UNKNOW = 0;
        OBSTACLE = 1;
        FREE = 2;
        CARPET = 3;
    }
    /**
     * 地图像素数据，目前采用 LZ4 压缩; [EN: Map pixel data, currently using LZ4 compression;]
     * 每个像素占 2bit，即4种值，与上面 enum PixelValue 对应. [EN: Each pixel occupies 2 bits, i.e. 4 values, corresponding to enum PixelValue above.]
     * 像素从字节低位bit开始. [EN: Pixels start from low bit of byte.]
     */
    bytes pixels = 4;   // 地图压缩 [EN: Map compressed]

    /**
     * 地图像素原始size, 如果pixels有压缩，则 pixel_size 表示解压后的长度. [EN: Original map pixel size, if pixels are compressed, pixel_size represents the decompressed length.]
     */
    uint32 pixel_size = 5;

    MapInfo info = 6;     // map 的信息 [EN: Map info]
    string name = 7;      // map 的名称 [EN: Map name]
    uint32 id = 8;        // map 的 id 号 [EN: Map ID number]
    uint32 releases = 9;  // map 的大版本修正号 [EN: Map major version revision number]

    message Index {
        uint32 value = 1;   // 地图索引，0 表示实时地图，1~MULTI_MAP_NUM 表示多地图中的地图索引 [EN: Map index, 0 means real-time map, 1~MULTI_MAP_NUM means map index in multi-maps]
    }
    Index index = 10;
}

/**
 * 路径数据，增量上传. [EN: Path data, incremental upload.]
 *
 * @note: Delimited 方式序列化. [EN: @note: Serialized in Delimited way.]
 */
/** xy 信息如下: [EN: xy info as follows:]
      byte 1-2:  x 坐标, byte1高字节，最高位为符号位, byte2为低字节; [EN:       byte 1-2: x coordinate, byte1 high byte, highest bit is sign bit, byte2 is low byte;]
      byte 3-4:  y 坐标，byte3高字节，最高位为符号位, byte4为低字节; [EN:       byte 3-4: y coordinate, byte3 high byte, highest bit is sign bit, byte4 is low byte;]
    flags 信息如下: [EN:     flags info as follows:]
      byte 1:    flags信息， [EN:       byte 1: flags info,]
        bit 0-3 类型，见下方定义： [EN:         bit 0-3 type, see definitions below:]
                SWEEP = 0,              // 纯扫 [EN:                 SWEEP = 0,              // Sweep only]
                MOP = 1,                // 纯拖地 [EN:                 MOP = 1,                // Mop only]
                SWEEP_MOP = 2,          // 扫+拖地 [EN:                 SWEEP_MOP = 2,          // Sweep + mop]
                FAST_MAPPING = 3,       // 快速建图运行轨迹 [EN:                 FAST_MAPPING = 3,       // Fast mapping path]
                CRUISIING = 4,          // 全屋巡航运行轨迹 [EN:                 CRUISIING = 4,          // Whole house cruise path]
                POINT_TO_POINT = 5,     // 指哪到哪运行轨迹 [EN:                 POINT_TO_POINT = 5,     // Point-to-point path]
                REMOTE_CTRL = 6,        // 遥控运行轨迹 [EN:                 REMOTE_CTRL = 6,        // Remote control path]
                GO_CHARGE_IN_WORK = 7,  // 任务中回充轨迹 [EN:                 GO_CHARGE_IN_WORK = 7,  // Return to charge path during task]
                GO_CHARGE = 8,          // 任务结束回充轨迹 [EN:                 GO_CHARGE = 8,          // Return to charge path after task]
                GO_WASH_IN_WORK = 9,    // 任务中回洗轨迹 [EN:                 GO_WASH_IN_WORK = 9,    // Return to wash path during task]
                GO_WASH = 10,           // 任务结束回洗轨迹 [EN:                 GO_WASH = 10,           // Return to wash path after task]
                EXPLORE_STATIONS = 11,  // 探索基站轨迹 [EN:                 EXPLORE_STATIONS = 11,  // Explore station path]
                NAVIGATION = 12,        // 分区之间导航轨迹 [EN:                 NAVIGATION = 12,        // Navigation path between partitions]
                RESUME_CLEANING = 13,   // 回充回洗后的续扫轨迹 [EN:                 RESUME_CLEANING = 13,   // Resume cleaning path after return to charge/wash]
                RETURN_START_POINT = 14,  // 回充失败再返回起点的轨迹 [EN:                 RETURN_START_POINT = 14,  // Return to start point path after failed charge return]
                HIDE = 15,  // 隐藏轨迹（轨迹优化使用）同时需要使能 AppFunction.optimization.PATH_HIDE_TYPE [EN:                 HIDE = 15,  // Hidden path (used for path optimization) also need to enable AppFunction.optimization.PATH_HIDE_TYPE]
        bit 4: 状态，0 - 继续上一轨迹点， 1 - 新轨迹点，与上一轨迹点不连续； [EN:         bit 4: state, 0 - continue from last path point, 1 - new path point, not continuous with last;]
        bit 5: 是否显示轨迹，0 - 不显示，1 - 显示； [EN:         bit 5: whether to show path, 0 - don't show, 1 - show;]
        bit 6: 是否显示机器人，0 - 不显示，1 - 显示； [EN:         bit 6: whether to show robot, 0 - don't show, 1 - show;]
        bit 7: 预留； [EN:         bit 7: reserved;]
      byte 2:    task_motion_type； [EN:       byte 2: task_motion_type;]
      byte 3-4:  预留； [EN:       byte 3-4: reserved;]
 */
message PathPoint {
    // bit0~15 为 x 坐标 [EN: bit0~15 is x coordinate]
    // bit16~31 为 y 坐标 [EN: bit16~31 is y coordinate]
    uint32 xy = 1;
    // bit0~3 为 point_type [EN: bit0~3 is point_type]
    // bit4 为 break_type [EN: bit4 is break_type]
    // bit5 为 show_trajectory_flag [EN: bit5 is show_trajectory_flag]
    // bit6 为 show_robot_flag [EN: bit6 is show_robot_flag]
    // bit7 预留 [EN: bit7 reserved]
    // bit8~15 为 task_motion_type [EN: bit8~15 is task_motion_type]
    // bit16~23 预留 [EN: bit16~23 reserved]
    // bit24~31 预留 [EN: bit24~31 reserved]
    uint32 flags = 2;
}

/**
 * 房间轮廓信息（使用包含分区信息的地图），单次上传. [EN: Room outline information (using map with partition info), single upload.]
 *
 * @note: Delimited 方式序列化. [EN: @note: Serialized in Delimited way.]
 */
 message RoomOutline {
    uint32 map_id = 1;    // map 的 id 号 [EN: Map ID number]
    uint32 releases = 2;  // map 的大版本修正号 [EN: Map major version revision number]

    uint32 width = 3;
    uint32 height = 4;
    uint32 resolution = 5; // 单位： m x 100 [EN: Unit: m x 100]
    Point origin = 6;

    /**
     * 地图像素数据，目前采用 LZ4 压缩; [EN: Map pixel data, currently using LZ4 compression;]
     * 每个像素占 1byte，表示房间 id [EN: Each pixel occupies 1 byte, represents room ID]
     */
    bytes pixels = 7;   // 地图压缩 [EN: Map compressed]

    /**
     * 地图像素原始size, 如果pixels有压缩，则 pixel_size 表示解压后的长度. [EN: Original map pixel size, if pixels are compressed, pixel_size represents the decompressed length.]
     */
    uint32 pixel_size = 8;
}

/**
 * 房间参数，单次上传. [EN: Room parameters, single upload.]
 *
 * @note: Delimited 方式序列化. [EN: @note: Serialized in Delimited way.]
 */
message RoomParams {
    // 定制化清扫参数使能. [EN: Customized cleaning parameters enable.]
    bool custom_enable = 1; // x10 以后不再使用 [EN: No longer used after x10]

    message Room {
        uint32 id = 1;
        string name = 2;  // 默认名称为 ""，表示未命名 [EN: Default name is "", means unnamed]
        Floor floor = 3;
        RoomScene scene = 4;  // 场景（类型+索引） [EN: Scene (type + index)]

        // 定制化顺序. [EN: Customized order.]
        message Order {
            uint32 value = 1;
        }
        Order order = 6;

        // 定制化参数. [EN: Customized parameters.]
        message Custom {
            CleanType clean_type = 1;
            Fan fan = 2;
            MopMode mop_mode = 3;
            CleanExtent clean_extent = 4;
            uint32 clean_times = 5; // 清扫次数，非 0 有效 [EN: Cleaning times, non-zero is valid]
        }
        Custom custom = 7;
    }
    repeated Room rooms = 2;

    uint32 map_id = 3;    // map 的 id 号 [EN: Map ID number]
    uint32 releases = 4;  // map 的大版本修正号 [EN: Map major version revision number]

    // enum ModeType {
    //     CUSTOM = 0;     // 通用/定制模式，x10 以后不再使用 [EN: General/custom mode, no longer used after x10]
    //     SMART = 1;      // 智能模式 [EN: Smart mode]
    // }
    // ModeType mode_type = 5;
    Switch smart_mode_sw = 6; // 智能省心模式开关 [EN: Smart hassle-free mode switch]
}

/**
 * 禁区信息，单次上传. [EN: Restricted zone information, single upload.]
 *
 * @note: Delimited 方式序列化. [EN: @note: Serialized in Delimited way.]
 */
message RestrictedZone {
    repeated Line virtual_walls = 1;
    repeated Quadrangle forbidden_zones = 2;
    repeated Quadrangle ban_mop_zones = 3;

    uint32 map_id = 4;    // map 的 id 号 [EN: Map ID number]
    uint32 releases = 5;  // map 的大版本修正号 [EN: Map major version revision number]

    // 自动推荐，只有推荐的禁区有 id 信息，由机器端生成，逐渐增加 [EN: Auto recommendation, only recommended restricted zones have id info, generated by device, gradually increases]
    // 机器要做到： [EN: Device should:]
    // 1. 存在推荐禁区后，再收到一次编辑禁区消息，需要删除推荐禁区，将设置的推荐禁区转为编辑禁区 [EN: 1. After recommended restricted zone exists, upon receiving edit restricted zone message again, need to delete recommended zone and convert set recommended zone to edited zone]
    // 2. 推荐的禁区没有被设置，那么机器后面就不应该再推荐这个禁区 [EN: 2. If recommended restricted zone is not set, device should not recommend this zone again later]
    message Suggestion {
        message LineWrap {
            uint32 id = 1;
            Line line = 2;
        }
        message QuadrangleWrap {
            uint32 id = 1;
            Quadrangle quadrangle = 2;
        }

        repeated LineWrap virtual_walls = 1;
        repeated QuadrangleWrap forbidden_zones = 2;
        repeated QuadrangleWrap ban_mop_zones = 3;
    }
    Suggestion suggestion = 7;
}

/**
 * 动态数据，单次上传. [EN: Dynamic data, single upload.]
 *
 * @note: Delimited 方式序列化. [EN: @note: Serialized in Delimited way.]
 */
message DynamicData {
    Pose cur_pose = 1;   // 当前位姿 [EN: Current pose]
}

/**
 * 存储临时数据，机器端不主动清除，app根据workstatus自行判断数据是否有效. [EN: Store temporary data, device doesn't proactively clear, app judges data validity based on workstatus.]
 * 单次上传. [EN: Single upload.]
 *
 * @note: Delimited 方式序列化. [EN: @note: Serialized in Delimited way.]
 */
message TemporaryData {
    .proto.cloud.SelectRoomsClean select_rooms_clean = 1;
    .proto.cloud.SelectZonesClean select_zones_clean = 2;
    .proto.cloud.Goto goto_location = 3;
    .proto.cloud.PointCruise select_point_cruise = 4;
    .proto.cloud.ZonesCruise select_zones_cruise = 5;
}

/**
 * 物体数据信息，单次上传. [EN: Object data information, single upload.]
 *
 * @note: Delimited 方式序列化. [EN: @note: Serialized in Delimited way.]
 */
message ObstacleInfo {
    uint32 map_id = 1;    // map 的 id 号 [EN: Map ID number]
    uint32 releases = 2;  // map 的大版本修正号 [EN: Map major version revision number]

    message Obstacle {
        string object_type = 1;

        enum ShowType {
            POSITION = 0;   // 坐标: show_points 只有一个 [EN: Coordinate: show_points has only one]
            OUTLINE = 1;    // 轮廓 [EN: Outline]
            FILL = 2;       // 填充 [EN: Fill]
            BITMAP = 3;     // 位图（左上坐标+长宽+mask序列，bit为0表示空，为1表示存在） [EN: Bitmap (top-left coordinate + width/height + mask sequence, bit 0 means empty, 1 means exists)]
        }
        ShowType show_type = 2;

        repeated Point show_points = 3;  // TODO: 考虑 3D [EN: TODO: Consider 3D]

        message Bitmap {
            Point ref_point = 1;    // 参考点，bitmap 以此为左上角 [EN: Reference point, bitmap uses this as top-left corner]
            uint32 width = 2;
            uint32 height = 3;
            uint32 data_len = 4;
            bytes data = 5;         // 单bit描述一个点，bit为0表示空，为1表示存在 [EN: Single bit describes one point, bit 0 means empty, 1 means exists]
        }
        Bitmap bitmap = 4;

        sint32 theta = 5;   // 物体方向，单位: rad * 100 [EN: Object direction, unit: rad * 100]

        string photo_id = 6;    // 照片 id [EN: Photo ID]

        uint32 accuracy = 7;    // 准确率，0~100，表示百分比（0 表示无效） [EN: Accuracy, 0~100, represents percentage (0 means invalid)]

        message Valid {
            bool value = 1;
        }
        Valid valid = 8;    // 是否有效 [EN: Whether valid]
    }
    repeated Obstacle obstacles = 3;
}

/**
 * 巡航数据. [EN: Cruise data.]
 * 更新频率：巡航指令后更新一次（照片 id 为空），结束巡航后更新一次（一次性写入照片 id） [EN: Update frequency: update once after cruise command (photo id is empty), update once after cruise ends (write photo id all at once)]
 *
 * @note: Delimited 方式序列化. [EN: @note: Serialized in Delimited way.]
 */
message CruiseData {
    message ProcessData {
        Point points = 1;   // 巡航点（收到巡航指令后更新一次，照片 id 可为空） [EN: Cruise point (update once after receiving cruise command, photo id can be empty)]

        repeated string photo_id = 2; // 每个巡航点关联的照片 id（结束巡航一次性写入） [EN: Photo ids associated with each cruise point (write all at once when cruise ends)]
    }
    repeated ProcessData cruise_data = 1;

    uint32 map_id = 2;    // map 的 id 号 [EN: Map ID number]
    uint32 releases = 3;  // map 的大版本修正号 [EN: Map major version revision number]
}

/**
 * 地图描述，单次上传. [EN: Map description, single upload.]
 *
 * @note: Delimited 方式序列化. [EN: @note: Serialized in Delimited way.]
 */
 message MapDescription {
    // id 1 不再使用 [EN: id 1 no longer used]

    string name = 2;        // 地图名 [EN: Map name]
    uint32 create_cause = 3;
    uint64 create_time = 4; // 创建时间 [EN: Creation time]
    uint64 last_time = 5;   // 最后更新时间 [EN: Last update time]
    uint32 map_id = 6;      // map 的 id 号 [EN: Map ID number]
    uint32 releases = 7;    // map 的大版本修正号 [EN: Map major version revision number]
}

/**
 * 地图备份，单次上传. [EN: Map backup, single upload.]
 *
 * @note: Delimited 方式序列化. [EN: @note: Serialized in Delimited way.]
 */
message MapBackup {
    MapDescription desc = 1;
    Map map = 2;
    RoomOutline rooms = 3;
    RoomParams room_params = 4;
    RestrictedZone restricted_zone = 5;
}

/**
 * 场景信息，单次上传. [EN: Scene information, single upload.]
 *
 * @note: Delimited 方式序列化. [EN: @note: Serialized in Delimited way.]
 */
message SceneWrap {
    message Scene {
        SceneInfo info = 1;
        repeated SceneTask tasks = 2;
    }
    repeated Scene scenes = 1;
}
