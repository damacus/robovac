syntax = "proto3";

// option optimize_for = LITE_RUNTIME;

package proto.cloud.p2p;

import "proto/cloud/common.proto";
import "proto/cloud/stream.proto";

/**
 * 地图数据的统一入口, 包括实时地图数据, 多地图相关数据. [EN: Unified entry for map data, including real-time map data and multi-map related data.]
 */
message MapChannelMsg {
    enum MsgType {
        MAP_INFO = 0;
        MULTI_MAP_RESPONSE = 1;
    }

    MsgType type = 1;
    oneof MsgData {
        /*
         * 实时地图数据不需要发送请求(为实时推送) [EN: Real-time map data doesn't need to send request (is real-time push)]
         */
        MapInfo map_info = 2;

        /*
         * 该成员解析为MultiMapsManageResponse类型, 需要发送相应DP请求. [EN: This member parses to MultiMapsManageResponse type, needs to send corresponding DP request.]
         */
        bytes multi_map_response = 3;
    }
}

/**
 * 房间轮廓信息（使用包含分区信息的地图），单次上传. [EN: Room outline information (using map with partition info), single upload.]
 *
 * @note: Delimited 方式序列化. [EN: @note: Serialized in Delimited way.]
 */
message MapPixels {
    /**
     * 地图像素数据，目前采用 LZ4 压缩; [EN: Map pixel data, currently using LZ4 compression;]
     * 地图更新采用SLAM地图+分区地图的方式维护，slam地图实时更新，分区地图仅在保存地图、用户手动调整分区时更新； [EN: Map update uses SLAM map + partition map method, SLAM map updates in real-time, partition map only updates when saving map or user manually adjusts partitions;]
     * 实时地图: [EN: Real-time map:]
     *      1byte表示4像素，即1个像素2bit: [EN:      1 byte represents 4 pixels, i.e. 1 pixel is 2 bits:]
     *          0x00 为未知区域 [EN:          0x00 is unknown area]
     *          0x01 为张障碍物 [EN:          0x01 is obstacle]
     *          0x02 为可清扫区域 [EN:          0x02 is sweepable area]
     *          0x03 为地毯 [EN:          0x03 is carpet]
     * 分区地图： [EN: Partition map:]
     *      1byte表示1像素的方式 [EN:      1 byte represents 1 pixel]
     *          低2bit表示像素 [EN:          Lower 2 bits represent pixel]
     *              0x00 为未知区域 [EN:              0x00 is unknown area]
     *              0x01 为张障碍物 [EN:              0x01 is obstacle]
     *              0x02 为可清扫区域 [EN:              0x02 is sweepable area]
     *              0x03 为地毯 [EN:              0x03 is carpet]
     *          高6bit表示房间分区id [EN:          Upper 6 bits represent room partition ID]
     *              每个像素占 1byte，包含房间id、是否是背景等数据. [EN:              Each pixel occupies 1 byte, contains room ID, whether it's background, etc.]
     *              房间标识说明 [EN:              Room identifier description]
     *                  有效房间标识: 0 - 31 [EN:                  Valid room identifier: 0 - 31]
     *                  无效房间标识: 大于等于32 [EN:                  Invalid room identifier: greater than or equal to 32]
     *              特殊房间标识： [EN:              Special room identifiers:]
     *                  60：没有房间数据 [EN:                  60: No room data]
     *                  61：房间间隙 [EN:                  61: Room gap]
     *                  62：代表障碍物 [EN:                  62: Represents obstacle]
     *                  63：未知的房间标识 [EN:                  63: Unknown room identifier]
     */
    bytes pixels = 1;   // 地图压缩 [EN: Map compressed]

    /**
     * 地图像素原始size, 如果pixels有压缩，则 pixel_size 表示解压后的长度. [EN: Original map pixel size, if pixels are compressed, pixel_size represents the decompressed length.]
     */
    uint32 pixel_size = 2;
}


/**
    p2p数据相当于直播，不会在云端保存，每次可以直接传输全量数据 [EN: p2p data is like live streaming, not saved in cloud, can transmit full data each time]
*/
message MapInfo {
    uint32 releases = 1;        //map 的大版本修正号, version [EN: Map major version revision number, version]
    uint32 map_id = 2;          // map 的 id 号, name/releases在后面 [EN: Map ID number, name/releases are below]
    bool map_stable = 3;        // 地图是否稳定 [EN: Whether map is stable]
    uint32 map_width = 4;
    uint32 map_height = 5;
    Point origin = 6;           // 原点 [EN: Origin]
    repeated Pose docks = 7;    // 支持多个充电座/基站 [EN: Supports multiple charging docks/stations]

    enum MapMsgType{
        MAP_REALTIME = 0;
        MAP_ROOMOUTLINE = 1;
        OBSTACLE_INFO = 2;
        RESTRICT_ZONES = 3;
        ROOM_PARAMS = 4;
        CRUISE_DATA = 5;
        TEMPORARY_DATA = 6;
    };
    MapMsgType msg_type = 8;

    oneof MapMsg { // 由 msg_type 决定包含哪种数据 [EN: Determined by msg_type which data to include]
        MapPixels pixels = 9; // 实时地图信息或房间轮廓信息 [EN: Real-time map info or room outline info]
        stream.ObstacleInfo obstacles = 10;
        stream.RestrictedZone restricted_zones = 11;
        stream.RoomParams room_params = 12;
        stream.CruiseData cruise_data = 13;
        stream.TemporaryData temporary_data = 14;
    }

    uint32 is_new_map = 15;    // p2p同时加入 [EN: p2p also included]
    string name       = 16;    // map 的名称 [EN: Map name]
}

message CompleteMap {
    uint32 releases = 1;        // map 的大版本修正号, version [EN: Map major version revision number, version]
    uint32 map_id = 2;
    bool map_stable = 3;        // 地图是否稳定 [EN: Whether map is stable]
    uint32 map_width = 4;
    uint32 map_height = 5;
    Point origin = 6;           // 原点 [EN: Origin]

    repeated Pose docks = 7;    // 支持多个充电座/基站 [EN: Supports multiple charging docks/stations]
    MapPixels map = 8; // 实时地图信息 [EN: Real-time map info]
    MapPixels room_outline = 9; // 房间轮廓信息 [EN: Room outline info]
    stream.ObstacleInfo obstacles = 10;
    stream.RestrictedZone restricted_zones = 11;
    stream.RoomParams room_params = 12;
    stream.TemporaryData temporary_data = 13;
    uint32 is_new_map = 14;     // p2p同时加入 [EN: p2p also included]
    string name       = 15;     // map 的名称 [EN: Map name]
}

/**
    一个路径点包含 5 个字节: [EN: A path point contains 5 bytes:]
      byte 1-2:  x 坐标, byte1高字节，最高位为符号位, byte2为低字节; [EN:       byte 1-2: x coordinate, byte1 high byte, highest bit is sign bit, byte2 is low byte;]
      byte 3-4:  y 坐标，byte3高字节，最高位为符号位, byte4为低字节; [EN:       byte 3-4: y coordinate, byte3 high byte, highest bit is sign bit, byte4 is low byte;]
      byte 5:    flags信息， [EN:       byte 5: flags info,]
        bit 0-3 类型，0 - 清扫，1 - 拖地，2 - 扫+拖，3 - 导航，4 - 回充 (TODO: 根据需求完善) [EN:         bit 0-3 type, 0 - sweep, 1 - mop, 2 - sweep+mop, 3 - navigation, 4 - return to charge (TODO: refine based on requirements)]
        bit 4: 状态，0 - 继续上一轨迹点， 1 - 新轨迹点，与上一轨迹点不连续； [EN:         bit 4: state, 0 - continue from last path point, 1 - new path point, not continuous with last;]
 */
message CompletePath {
    enum Type{
        SWEEP = 0;
        MOP = 1;
        SWEEP_MOP = 2;
        NAVI = 3;
        GOHOME = 4;
    };
    enum State {
        FOLLOW = 0;    // 继续上一轨迹点 [EN: Continue from last path point]
        NEW = 1;       // 新轨迹点，与上一轨迹点不连续 [EN: New path point, not continuous with last]
    }
    bytes path = 3;             //lz4压缩 [EN: lz4 compressed]
    uint32 path_lz4len = 4;     //压缩原始长度 [EN: Original length before compression]
}
